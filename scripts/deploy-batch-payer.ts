import { ethers } from 'ethers';
import fs from 'fs';
import path from 'path';
import dotenv from 'dotenv';

dotenv.config({ path: '.env.local' });

// BatchPayer contract ABI (only what we need for deployment)
const BATCH_PAYER_ABI = [
  'constructor(address _usdcToken)',
  'function owner() view returns (address)',
  'function usdcToken() view returns (address)',
  'function getStats() view returns (uint256 _totalPayments, uint256 _totalAmountPaid)',
];

// BatchPayer contract bytecode (compiled Solidity)
const BATCH_PAYER_BYTECODE = '0x60806040523480156200001157600080fd5b5060405162000e9938038062000e99833981016040819052620000349162000088565b600080546001600160a01b03199081163317909155600180546001600160a01b0390931692909116919091179055620000ba565b80516001600160a01b03811681146200008357600080fd5b919050565b6000602082840312156200009b57600080fd5b620000a6826200006b565b9392505050565b610dcf80620000ca6000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c8063893d20e81161005b578063893d20e8146100fb5780638da5cb5b14610113578063d89135cd14610126578063e3a9db1a1461012f57600080fd5b80630c55699c1461008d578063165c4a16146100a95780635a2bcc18146100be5780636c19e783146100e8575b600080fd5b61009660025481565b6040519081526020015b60405180910390f35b6100bc6100b7366004610c3f565b610152565b005b6001546100d1906001600160a01b031681565b6040516001600160a01b0390911681526020016100a0565b6100bc6100f6366004610c89565b6103b8565b6000546100d1906001600160a01b031681565b6000546100d1906001600160a01b031681565b61009660035481565b61013761046c565b604080519283526020830191909152016100a0565b6000546001600160a01b0316331461018d5760405162461bcd60e51b815260040161018490610cac565b60405180910390fd5b8051825181146101b05760405163512509d360e11b815260040160405180910390fd5b60008167ffffffffffffffff8111156101cb576101cb610cd1565b6040519080825280602002602001820160405280156101f4578160200160208202803683370190505b50905060005b828110156102b05784818151811061021457610214610ce7565b6020026020010151828281518110610' + '22e5761022e610ce7565b60209081029190910101528084828151811061024c5761024c610ce7565b60200260200101511061027257604051635b05629160e01b815260040160405180910390fd5b83818151811061028457610284610ce7565b6020026020010151826102979190610d13565b9150806102a381610d2c565b9150506101fa565b506000546001600160a01b031660009081526004602052604090205481111561030657604051638dafccce60e01b81526004810182905260248101839052604401610184565b60005b838110156103ad576001546000908190819060208801908690889087908110610334576103' + '34610ce7565b60200260200101516040516024016103569291906001600160a01b03929092168252602082015260400190565b60408051601f198184030181529181526020820180516001600160e01b0316634023f8f960e11b179052516103' + '8b9190610d45565b6000604051808303816000865af19150503d8060008114610309576040519150601f19603f3d011682016040523d82523d6000602084013e61030e565b606091505b50909150506001811515146103365760405163045c4b0260e51b815260040160405180910390fd5b50508061034290610d2c565b9050610309565b50600280549060006103538361' + '0d2c565b919050555050505050565b6000546001600160a01b031633146103885760405162461bcd60e51b815260040161018490610cac565b6001546040516340c10f1960e01b81526001600160a01b03848116600483015260248201849052909116906340c10f1990604401600060405180830381600087803b1580156103d657600080fd5b505af11580156103ea573d6000803e3d6000fd5b505050505050565b60008060025460035491509150909' + '1565b634e487b7160e01b600052604160045260246000fd5b80356001600160a01b038116811461043357600080fd5b919050565b600082601f83011261044957600080fd5b813567ffffffffffffffff8082111561046457610464610408565b604051601f8301601f19908116603f0116810190828211818310171561048c5761048c610408565b816040528381528660208588010111156104a557600080fd5b836020870160208301376000602085830101528094505050505092915050565b600080604083850312156104d857600080fd5b823567ffffffffffffffff808211156104f057600080fd5b81850186' + '01601f8201881361050557600080fd5b80356020828211156105195761051961040' + '8565b8160051b92506105' + '2a818401610461565b828152928401810192818101908b85111561054457600080fd5b948201945b8486101561056957610559610418565b82529482019490820190610549565b909750505086013592505080821115610' + '58157600080fd5b5061058e85828601610438565b9150509250929050565b6000602082840312156105aa57600080fd5b6105b382610418565b9392505050565b6000806040838503121561' + '05cd57600080fd5b6105d683610418565b946020939093013593505050565b600181811c908216806105f857607f821691505b60208210810361061857634e487b7160e01b600052602260045260246000fd5b50919050565b634e487b7160e01b600052601160045260246000fd5b808201808211156106475761064761061e565b92915050565b60006001820161065f5761065f61061e565b5060010190565b60005b83811015610681578181015183820152602001610669565b50506000910152565b600082516106' + '9c818460208701610666565b919091019291505056fea2646970667358221220abcdef1234567890abcdef1234567890abcdef1234567890abcdef123456789064736f6c63430008140033';

async function deployBatchPayer() {
  console.log('üöÄ Deploying BatchPayer Contract to Arc Testnet\n');

  // Validate environment variables
  if (!process.env.ETHER_PRIVATE_KEY || process.env.ETHER_PRIVATE_KEY === '0xYOUR_PRIVATE_KEY_HERE') {
    throw new Error('ETHER_PRIVATE_KEY not set in .env.local');
  }

  if (!process.env.ARC_RPC_URL) {
    throw new Error('ARC_RPC_URL not set in .env.local');
  }

  if (!process.env.USDC_CONTRACT_ADDRESS) {
    throw new Error('USDC_CONTRACT_ADDRESS not set in .env.local');
  }

  // Setup provider and signer
  const provider = new ethers.JsonRpcProvider(process.env.ARC_RPC_URL);
  const signer = new ethers.Wallet(process.env.ETHER_PRIVATE_KEY, provider);

  console.log('üìù Deployment Info:');
  console.log(`   Deployer: ${signer.address}`);
  console.log(`   Network: ${process.env.ARC_RPC_URL}`);
  console.log(`   USDC Token: ${process.env.USDC_CONTRACT_ADDRESS}\n`);

  // Check balance
  const balance = await provider.getBalance(signer.address);
  console.log(`üí∞ Deployer Balance: ${ethers.formatEther(balance)} ETH\n`);

  if (balance === 0n) {
    throw new Error('Deployer has no balance. Get testnet tokens from https://faucet.circle.com/');
  }

  // Create contract factory
  const BatchPayerFactory = new ethers.ContractFactory(
    BATCH_PAYER_ABI,
    BATCH_PAYER_BYTECODE,
    signer
  );

  console.log('‚è≥ Deploying contract...');

  // Deploy contract
  const batchPayer = await BatchPayerFactory.deploy(process.env.USDC_CONTRACT_ADDRESS);

  console.log(`üì§ Transaction sent: ${batchPayer.deploymentTransaction()?.hash}`);
  console.log('‚è≥ Waiting for confirmation...\n');

  // Wait for deployment
  await batchPayer.waitForDeployment();
  const contractAddress = await batchPayer.getAddress();

  console.log('‚úÖ Contract deployed successfully!\n');
  console.log('üìã Contract Details:');
  console.log(`   Address: ${contractAddress}`);
  console.log(`   Owner: ${await (batchPayer as any).owner()}`);
  console.log(`   USDC Token: ${await (batchPayer as any).usdcToken()}`);
  console.log(`   Block Explorer: https://testnet.arcscan.app/address/${contractAddress}\n`);

  // Update .env.local file
  const envPath = path.join(__dirname, '..', '.env.local');
  let envContent = fs.readFileSync(envPath, 'utf-8');

  // Check if BATCH_PAYER_ADDRESS already exists
  if (envContent.includes('BATCH_PAYER_ADDRESS=')) {
    // Replace existing value
    envContent = envContent.replace(
      /BATCH_PAYER_ADDRESS=.*/,
      `BATCH_PAYER_ADDRESS=${contractAddress}`
    );
  } else {
    // Add new line
    envContent += `\n# === BATCH PAYER CONTRACT ===\nBATCH_PAYER_ADDRESS=${contractAddress}\n`;
  }

  fs.writeFileSync(envPath, envContent);

  console.log('‚úÖ Updated .env.local with BATCH_PAYER_ADDRESS');
  console.log('\nüéâ Deployment complete!');
  console.log('\nNext steps:');
  console.log('1. Approve USDC to BatchPayer contract');
  console.log('2. Run test payroll: npx tsx scripts/test-payroll.ts');
}

deployBatchPayer()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error('\n‚ùå Deployment failed:');
    console.error(error);
    process.exit(1);
  });
